<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boldog Újévet!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@800&display=swap" rel="stylesheet">
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Chroma Key (Green/Black Screen Removal) */
        .chroma-key-green {
            filter: url(#chroma-key-green-filter);
        }

        .chroma-key-black {
            mix-blend-mode: screen;
        }

        .meme-gif {
            position: absolute;
            pointer-events: none;
            display: none;
        }

        .meme-full {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .meme-side {
            height: 40%;
            top: 30%;
            object-fit: contain;
        }

        .meme-left {
            left: 0;
        }

        .meme-right {
            right: 0;
        }

        #gameBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1;
        }

        #memeLayerBehind {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #memeLayerAbove {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #gameCanvas {
            position: relative;
            z-index: 3;
            background: transparent !important;
        }

        .game-score,
        .health-display,
        .game-ui,
        .menu-overlay {
            z-index: 4002;
        }

        /* Game UI Styles */
        .game-score {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
            z-index: 4002;
            text-shadow: 2px 2px 0 #000;
        }

        .menu-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #ffd700;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            color: white;
            z-index: 5000;
            display: none;
            min-width: 300px;
        }

        .menu-overlay h1 {
            color: #ffd700;
            margin-top: 0;
            text-transform: uppercase;
        }

        .menu-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin: 10px 0;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
        }

        .menu-btn:hover {
            background: #00acc1;
        }

        .menu-btn.shop {
            background: #9c27b0;
        }

        .menu-btn.exit {
            background: #f44336;
        }

        .menu-btn.back {
            background: #777;
        }

        .shop-item {
            background: #333;
            border: 2px solid #555;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            text-align: left;
        }

        .shop-item button {
            width: 100%;
            padding: 10px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .shop-item button:disabled {
            background: #555;
            cursor: not-allowed;
            color: #888;
        }

        /* Original Styles */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Prevent scrolling */
            font-family: 'Outfit', sans-serif;
        }

        /* Game Overlay Styles */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 4000;
            /* Below viruses but above everything else */
            display: none;
            cursor: crosshair;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .game-ui {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 4001;
            display: flex;
            gap: 10px;
        }

        .finish-btn {
            background: #ff0000;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        .ingame-shop-btn {
            background: #9c27b0;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }

        .level2-btn {
            background: #ff9800;
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: none;
            /* Shown after boss kill */
        }

        .level2-btn.centered {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            padding: 20px 40px;
            z-index: 5000;
        }

        .wasd-tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            z-index: 5001;
            display: none;
            opacity: 0.9;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        .health-display {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 4002;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 2px 2px 0 #000;
        }

        .health-bar-container {
            width: 200px;
            height: 20px;
            background: #333;
            border: 2px solid white;
            border-radius: 10px;
            overflow: hidden;
        }

        .volume-display {
            position: absolute;
            top: 60px;
            left: 20px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 4002;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 2px 2px 0 #000;
        }

        .volume-slider {
            width: 150px;
            cursor: pointer;
        }

        .health-bar-fill {
            height: 100%;
            background: #00ff00;
            width: 100%;
            transition: width 0.2s;
        }

        .start-game-btn {
            margin-top: 1rem;
            background: #00bcd4;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #008ba3;
        }

        .start-game-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        body {
            background-image: url('marcigany.gif');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Center vertically */
            height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            /* Increased gap */
            z-index: 10;
            width: 95%;
            max-width: 1600px;
            /* Wider max-width */
            height: 95vh;
            justify-content: center;
        }

        .message {
            font-size: 6rem;
            /* Much bigger */
            font-weight: 800;
            color: white;
            text-align: center;
            text-shadow:
                4px 4px 0 #000,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            animation: pulse 2s infinite;
            margin-top: 2rem;
            /* Moved down a bit */
            margin-bottom: 1rem;
            flex-shrink: 0;
            line-height: 1;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            width: 100%;
            flex: 1;
            min-height: 0;
        }

        /* Video Styles */
        .video-container {
            flex: 0 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 65%;
            /* Allow it to take more width */
        }

        video {
            max-height: 65vh;
            /* Larger video */
            max-width: 100%;
            width: auto;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: block;
        }

        /* Slot Machine Styles */
        .slot-machine-container {
            flex: 0 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 1.5rem;
            border-radius: 20px;
            border: 4px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            transform: scale(1);
        }

        .slot-title {
            font-size: 2rem;
            font-weight: 900;
            color: #ffd700;
            text-transform: uppercase;
            text-shadow: 0 2px 0 #b8860b;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .slot-window {
            display: flex;
            gap: 10px;
            background: #333;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #555;
            overflow: hidden;
        }

        .reel {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid #000;
            position: relative;
        }

        .reel-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            /* Transition set dynamically in JS */
        }

        .reel-strip img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        .spin-btn {
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            border: none;
            padding: 0.8rem 2.5rem;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            color: #4a3c00;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow:
                0 4px 0 #8b6508,
                0 5px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
            min-width: 150px;
            /* Fixed width to prevent jumping when text changes */
        }

        .spin-btn:active {
            transform: translateY(4px);
            box-shadow:
                0 0 0 #8b6508,
                0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .spin-btn:disabled {
            /* We don't use disabled anymore for SKIP logic, but keeping style just in case */
            filter: grayscale(0.8);
            cursor: not-allowed;
        }

        /* Scam Overlay */
        .scam-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .scam-modal {
            background: #222;
            border: 2px solid #ffd700;
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            color: white;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            text-align: center;
            overflow-y: auto;
            max-height: 90vh;
        }

        .scam-title {
            font-size: 3rem;
            color: #ffd700;
            margin: 0 0 1rem 0;
            text-transform: uppercase;
        }

        .scam-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #ddd;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #ffd700;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #555;
            background: #333;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .scam-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .claim-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            flex: 1;
            min-width: 150px;
            transition: transform 0.1s;
        }

        .claim-btn:active {
            transform: scale(0.95);
        }

        .refuse-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            flex: 1;
            min-width: 150px;
            transition: transform 0.1s;
        }

        .refuse-btn:active {
            transform: scale(0.95);
        }

        /* Hekas Overlay */
        .hekas-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .hekas-overlay img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Win Overlay */
        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .win-text {
            font-size: 8rem;
            font-weight: 900;
            text-align: center;
            line-height: 1.1;
            background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: rainbow 2s linear infinite, shake 0.5s ease-in-out infinite;
            text-transform: uppercase;
        }

        .close-btn {
            margin-top: 2rem;
            padding: 1rem 2rem;
            font-size: 1.5rem;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        @keyframes rainbow {
            0% {
                filter: hue-rotate(0deg);
            }

            100% {
                filter: hue-rotate(360deg);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        @media (max-width: 1200px) {
            .message {
                font-size: 4rem;
            }

            .main-content {
                gap: 1rem;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .video-container {
                width: 100%;
                max-width: 100%;
            }

            video {
                max-height: 30vh;
            }

            .slot-machine-container {
                transform: scale(0.9);
            }

            .message {
                font-size: 3rem;
                margin-top: 1rem;
            }
        }

        /* Virus Popup Styles */
        .popup {
            position: absolute;
            width: 280px;
            z-index: 5000;
            /* On top of everything */
        }

        .style-classic {
            background-color: #c0c0c0;
            border: 2px outset white;
            box-shadow: 10px 10px 5px rgba(0, 0, 0, 0.5);
            font-family: Arial, sans-serif;
        }

        .style-classic .popup-header {
            background: linear-gradient(90deg, darkblue, blue);
            color: white;
            padding: 3px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .style-classic .popup-close {
            background-color: #c0c0c0;
            color: black;
            border: 1px outset white;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 14px;
            font-size: 12px;
            cursor: pointer;
        }

        .style-terminal {
            background-color: black;
            border: 2px solid lime;
            color: lime;
            font-family: 'Consolas', monospace;
        }

        .style-terminal .popup-header {
            background: lime;
            color: black;
            padding: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .style-terminal .popup-close {
            background: black;
            color: lime;
            border: 1px solid black;
            cursor: pointer;
        }

        .style-alert {
            background-color: #ffcccc;
            border: 4px solid red;
            color: red;
            font-family: Arial, sans-serif;
        }

        .style-alert .popup-header {
            background: red;
            color: white;
            padding: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .style-alert .popup-close {
            background: white;
            color: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            cursor: pointer;
        }

        .style-flashy {
            background-color: yellow;
            border: 3px dashed magenta;
            font-family: 'Comic Sans MS', sans-serif;
        }

        .style-flashy .popup-header {
            background: magenta;
            color: yellow;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            padding: 2px;
        }

        .style-flashy .popup-close {
            background: yellow;
            color: magenta;
            border: 1px solid magenta;
            cursor: pointer;
        }

        .popup-content {
            padding: 10px;
            text-align: center;
            color: black;
        }

        .style-terminal .popup-content {
            color: lime;
        }

        .style-alert .popup-content {
            color: red;
        }

        .style-flashy .popup-content {
            color: blue;
        }

        .popup img {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <!-- SVG Chroma Key Filters -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
        <filter id="chroma-key-green-filter" color-interpolation-filters="sRGB">
            <feColorMatrix type="matrix" values="
                1 0 0 0 0
                0 1 0 0 0
                0 0 1 0 0
                1.5 -3 1.5 1 0
            " />
            <feComponentTransfer>
                <feFuncA type="table" tableValues="0 1" />
            </feComponentTransfer>
        </filter>
    </svg>
    <div class="content-wrapper">
        <div class="message">
            Boldog újévet!
        </div>

        <div class="main-content">
            <!-- Video Section -->
            <div class="video-container">
                <video id="radicsVideo" autoplay loop playsinline controls
                    onerror="console.error('Video error:', this.src)">
                    <source src="./radics.mp4" type="video/mp4">
                    A böngésződ nem támogatja a videó lejátszását.
                </video>
            </div>

            <!-- Slot Machine Section -->
            <div class="slot-machine-container">
                <div class="slot-title">SZERENCSEJÁTÉK!!!!!!!!</div>
                <div class="slot-window">
                    <div class="reel" id="reel1">
                        <div class="reel-strip"></div>
                    </div>
                    <div class="reel" id="reel2">
                        <div class="reel-strip"></div>
                    </div>
                    <div class="reel" id="reel3">
                        <div class="reel-strip"></div>
                    </div>
                </div>
                <button class="spin-btn" id="spinBtn">SPIN</button>
                <button class="start-game-btn" id="startGameBtn">JÁTÉK</button>
            </div>
        </div>
    </div>

    <!-- Scam Form Overlay -->
    <div class="scam-overlay" id="scamOverlay">
        <div class="scam-modal">
            <h1 class="scam-title">NYERTÉL!</h1>
            <p class="scam-subtitle">nyertél 1.000.000.000 robuxot, hogy átvedd írd le ezeket az adataid:</p>

            <div class="form-group">
                <label>1. Kártyaszám</label>
                <input type="text" placeholder="XXXX XXXX XXXX XXXX">
            </div>
            <div class="form-group">
                <label>2. Lejárati dátum</label>
                <input type="text" placeholder="HH/ÉÉ">
            </div>
            <div class="form-group">
                <label>3. CV kód</label>
                <input type="text" placeholder="XXX">
            </div>
            <div class="form-group">
                <label>4. Facebook jelszavad</label>
                <input type="password" placeholder="********">
            </div>
            <div class="form-group">
                <label>5. Név</label>
                <input type="text" placeholder="Teljes név">
            </div>

            <div class="scam-buttons">
                <button class="claim-btn" id="claimBtn">Robux igénylése</button>
                <button class="refuse-btn" id="refuseBtn">Nem szeretném megadni az adataim</button>
            </div>
        </div>
    </div>

    <!-- Hekas Overlay -->
    <div class="hekas-overlay" id="hekasOverlay">
        <img src="./hekas.gif" alt="HEKAS" onerror="console.error('Hekas load failed')">
    </div>

    <!-- Game Overlay -->
    <div class="game-overlay" id="gameOverlay">
        <div id="memeLayerBehind"></div>
        <div id="gameBackground"></div>
        <div id="memeLayerAbove"></div>
        <canvas id="gameCanvas"></canvas>
        <img id="wasdTutorial" src="./wasd.png" class="wasd-tutorial" alt="WASD Control Tutorial"
            onerror="console.error('WASD tutorial load failed')">
        <div class="game-score">Pénz: <span id="scoreDisplay" style="cursor: pointer; text-decoration: underline;"
                onclick="cheatScore()" title="Kattints a csaláshoz!">0</span></div>

        <div class="health-display">
            Élet:
            <div class="health-bar-container">
                <div class="health-bar-fill" id="healthBarFill"></div>
            </div>
        </div>

        <div class="volume-display">
            Hangerő:
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.4">
        </div>

        <div class="game-ui">
            <button class="level2-btn" id="level2Btn" onclick="startLevel2()">MÁSODIK PÁLYA</button>
            <button class="ingame-shop-btn" id="ingameShopBtn" onclick="openShopIngame()">BOLT</button>
            <button class="finish-btn" id="finishGameBtn">BEFEJEZÉS</button>
        </div>

        <!-- Post Game Menu -->
        <div id="postGameMenu" class="menu-overlay">
            <h1>Játék Vége</h1>
            <button class="menu-btn" id="restartBtn">Újrakezdés</button>
            <button class="menu-btn shop" id="shopBtn">Bolt</button>
            <button class="menu-btn exit" onclick="document.getElementById('finishGameBtn').click()">Kilépés</button>
        </div>

        <!-- Shop Menu -->
        <div id="shopMenu" class="menu-overlay">
            <h1>Bolt</h1>
            <p>Pénz: <span id="shopMoneyDisplay" style="cursor: pointer; text-decoration: underline;"
                    onclick="cheatScore()">0</span></p>
            <div class="shop-item">
                <button id="upg1Btn" onclick="buyUpgrade(1)">10 Pont - Automáta (14/mp)</button>
            </div>
            <div class="shop-item">
                <button id="upg2Btn" onclick="buyUpgrade(2)">30 Pont - Gyorstüzelés (20/mp + Dupla)</button>
            </div>
            <div class="shop-item">
                <button id="upg3Btn" onclick="buyUpgrade(3)">50 Pont - Tükörhajó</button>
            </div>
            <button class="menu-btn back" onclick="closeShop()">Vissza</button>
        </div>
    </div>

    <!-- Virus Container -->
    <div id="virus-container"></div>

    <!-- Win Overlay -->
    <div class="win-overlay" id="winOverlay">
        <div class="win-text">BUZI VAGY</div>
        <button class="close-btn" onclick="document.getElementById('winOverlay').style.display='none'">X</button>
    </div>

    <!-- Sounds -->
    <audio id="bgMusic" src="./zene.mp3" preload="auto" loop
        onerror="console.error('zene.mp3 load failed', this.src)"></audio>
    <audio id="bgMusic2" src="./zene2.mp3" preload="auto"
        onerror="console.error('zene2.mp3 load failed', this.src)"></audio>

    <link rel="preload" as="image" href="./meme_fekete.gif">

    <script>
        // Redirect to add trailing slash if missing (fixes relative paths on GitHub Pages)
        if (window.location.pathname.endsWith('/dabo')) {
            window.location.replace(window.location.href + '/');
        }

        // Global variables for audio and slot UI elements
        let bgMusic, bgMusic2, spinSound, winSound, volumeSlider;
        let scamOverlay, hekasOverlay, claimBtn, refuseBtn, virusContainer;
        let spinBtn, reelStrips, winOverlay;
        let images = ['./1.png', './2.gif', './3.png', './4.png'];

        function initAudio() {
            // Browsers often need a user gesture to resume the AudioContext or play.
            if (bgMusic && bgMusic.paused && gameRunning) {
                bgMusic.play().catch(() => { });
            }
            if (bgMusic2 && bgMusic2.paused && currentLevel === 2) {
                bgMusic2.play().catch(() => { });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize global variables
            bgMusic = document.getElementById('bgMusic');
            bgMusic2 = document.getElementById('bgMusic2');
            spinSound = document.getElementById('spinSound');
            winSound = document.getElementById('winSound');
            volumeSlider = document.getElementById('volumeSlider');
            scamOverlay = document.getElementById('scamOverlay');
            hekasOverlay = document.getElementById('hekasOverlay');
            claimBtn = document.getElementById('claimBtn');
            refuseBtn = document.getElementById('refuseBtn');
            virusContainer = document.getElementById('virus-container');

            spinBtn = document.getElementById('spinBtn');
            winOverlay = document.getElementById('winOverlay');
            reelStrips = [
                document.querySelector('#reel1 .reel-strip'),
                document.querySelector('#reel2 .reel-strip'),
                document.querySelector('#reel3 .reel-strip')
            ];

            // Add global click listener for audio "unlocking"
            document.body.addEventListener('mousedown', initAudio, { once: true });
            document.body.addEventListener('touchstart', initAudio, { once: true });
            document.body.addEventListener('keydown', initAudio, { once: true });

            // Video autoplay logic
            const video = document.getElementById('radicsVideo');
            if (video) {
                video.volume = 1.0;
                video.play().catch(error => {
                    console.log("Az automatikus lejátszás hanggal nem sikerült:", error);
                });
            }

            // Initial volume setup
            if (bgMusic) bgMusic.volume = 0.4;
            if (bgMusic2) bgMusic2.volume = 0.4;

            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    const vol = e.target.value;
                    if (bgMusic) bgMusic.volume = vol;
                    if (bgMusic2) bgMusic2.volume = vol;
                });
            }

            const iconHeight = 80;
            const numIcons = images.length;
            const loops = 12;

            // Initialize Reels
            if (reelStrips[0]) {
                reelStrips.forEach(strip => {
                    let html = '';
                    for (let i = 0; i < loops; i++) {
                        images.forEach(img => {
                            html += `<img src="${img}" alt="icon">`;
                        });
                    }
                    strip.innerHTML = html;
                });
            }

            let isSpinning = false;
            let spinTimeout;

            spinBtn.addEventListener('click', () => {
                if (isSpinning) {
                    skipSpin();
                    return;
                }

                isSpinning = true;
                spinBtn.textContent = "SKIP";
                try {
                    if (spinSound) spinSound.currentTime = 0;
                } catch (e) { }
                if (spinSound) spinSound.play().catch(e => console.log("Audio play failed", e));

                const results = [
                    Math.floor(Math.random() * numIcons),
                    Math.floor(Math.random() * numIcons),
                    Math.floor(Math.random() * numIcons)
                ];

                spinBtn.dataset.results = JSON.stringify(results);

                reelStrips.forEach((strip, index) => {
                    const targetIndex = results[index];
                    const targetPosition = ((loops - 2) * numIcons + targetIndex) * iconHeight;

                    strip.style.transition = 'none';
                    strip.style.transform = 'translateY(0)';
                    strip.offsetHeight;

                    const duration = 1.0 + (index * 0.1);
                    strip.style.transition = `transform ${duration}s cubic-bezier(0.2, 0.8, 0.2, 1)`;
                    strip.style.transform = `translateY(-${targetPosition}px)`;
                });

                spinTimeout = setTimeout(() => {
                    finishSpin(results);
                }, 1300);
            });

            function skipSpin() {
                clearTimeout(spinTimeout);
                const results = JSON.parse(spinBtn.dataset.results);
                reelStrips.forEach((strip, index) => {
                    const targetIndex = results[index];
                    const targetPosition = ((loops - 2) * numIcons + targetIndex) * iconHeight;
                    strip.style.transition = 'none';
                    strip.style.transform = `translateY(-${targetPosition}px)`;
                });
                finishSpin(results);
            }

            function finishSpin(results) {
                isSpinning = false;
                spinBtn.textContent = "SPIN";
                spinSound.pause();

                const img1 = images[results[0]];
                const img2 = images[results[1]];
                const img3 = images[results[2]];

                if (img1 === img2 && img2 === img3) {
                    triggerWin();
                }
            }

            function triggerWin() {
                scamOverlay.style.display = 'flex';
            }

            // --- GAME LOGIC ---
            const startGameBtn = document.getElementById('startGameBtn');
            const gameOverlay = document.getElementById('gameOverlay');
            const gameCanvas = document.getElementById('gameCanvas');
            const finishGameBtn = document.getElementById('finishGameBtn');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const healthBarFill = document.getElementById('healthBarFill');

            // Menus
            const postGameMenu = document.getElementById('postGameMenu');
            const shopMenu = document.getElementById('shopMenu');
            const restartBtn = document.getElementById('restartBtn');
            const shopBtn = document.getElementById('shopBtn');
            const shopMoneyDisplay = document.getElementById('shopMoneyDisplay');

            let maxPlayerHP = 10;
            let gameRunning = false;
            let isPaused = false;

            // Focus handling (Moved here to avoid TDZ)
            document.addEventListener('visibilitychange', () => {
                const bg1 = document.getElementById('bgMusic');
                const bg2 = document.getElementById('bgMusic2');
                const activeMusic = (typeof currentLevel !== 'undefined' && currentLevel === 2) ? bg2 : bg1;
                if (document.hidden) {
                    if (activeMusic && gameRunning && !isPaused) activeMusic.pause();
                } else {
                    if (activeMusic && gameRunning && !isPaused) {
                        activeMusic.play().catch(e => console.log("Audio play failed on return", e));
                    }
                }
            });

            let ctx = gameCanvas.getContext('2d');
            let playerX = 0;
            let bullets = [];
            let enemies = [];
            let particles = [];
            let bossMissiles = [];
            let lastTime = 0;
            let enemySpawnTimer = 0;
            let gameOver = false;
            let gameElapsedTime = 0;
            let playerHP = 10;

            // Level 2 State
            let currentLevel = 1;
            let level2Phase = 0; // 0=none, 1=top spawning, 2=free move+rotate, 3=homing predators
            let playerY = 0;
            let playerAngle = 0;
            let keysPressed = {};
            let mouseX = 0;
            let mouseY = 0;
            let dashCooldown = 0;
            let dashTimer = 0;
            let wasdShowState = 0; // 0=waiting, 1=showing, 2=keyPressed, 3=done
            let wasdHideTimer = 0;

            window.addEventListener('keydown', (e) => { keysPressed[e.key.toLowerCase()] = true; });
            window.addEventListener('keyup', (e) => { keysPressed[e.key.toLowerCase()] = false; });
            window.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            window.startLevel2 = function () {
                currentLevel = 2;
                level2Phase = 1;
                gameRunning = true;
                isPaused = false;
                gameOver = false;
                gameWon = false;
                lastTime = performance.now();
                gameElapsedTime = 0;
                playerHP = 10;
                updateHealthUI();
                bullets = [];
                enemies = [];
                particles = [];
                bossMissiles = [];
                hasMirrorShip = false; // Törlődjön a második pályán

                bgMusic.pause();
                bgMusic2.currentTime = 32;
                bgMusic2.play().catch(e => console.log("Audio play failed", e));

                gameCanvas.width = window.innerWidth;
                gameCanvas.height = window.innerHeight;
                playerX = gameCanvas.width / 2;
                playerY = gameCanvas.height - 50;

                const btn = document.getElementById('level2Btn');
                btn.style.display = 'block';
                btn.classList.remove('centered');
                gameOverlay.style.display = 'block';
                postGameMenu.style.display = 'none';
                requestAnimationFrame(gameLoop);
            };

            // Boss State
            let loadingProgress = 0; // 0 to 40
            let bossActive = false;
            let boss = {
                x: 0, y: -250, w: 200, h: 200,
                hp: 200, maxHp: 200,
                phase: 1, // 1=static, 2=moving
                moveTimer: 0,
                attackTimer: 0,
                laserState: 0, // 0=none, 1=warn, 2=fire, 3=cooldown
                laserTimer: 0,
                targetX: 0
            };

            // Meme System State
            let memeTimers = { alt23: 0, m5: 0, m6: 0, m1: 0, m4: 0, m7: 0 };
            let altMemeToggle = false;
            let bossMemeTriggered = false;

            function showMeme(src, layerId, duration, className) {
                const layer = document.getElementById(layerId);
                if (!layer) return;

                const img = document.createElement('img');
                img.src = './' + src; // Explicit relative path
                img.onerror = () => console.error('Meme load failed:', img.src);
                img.className = 'meme-gif ' + className;
                img.style.display = 'block';
                layer.appendChild(img);

                setTimeout(() => {
                    if (img.parentNode) img.remove();
                }, duration);
            }

            // State
            let score = 0;
            let autoFireLevel = 0; // 0=none, 1=7/s, 2=14/s
            let hasMirrorShip = false;
            let isMouseDown = false;
            let lastShotTime = 0;

            // Global access for HTML onclicks
            window.buyUpgrade = function (type) {
                if (type === 1) {
                    if (score >= 10) { score -= 10; autoFireLevel = 1; }
                } else if (type === 2) {
                    if (score >= 30) { score -= 30; autoFireLevel = 2; }
                } else if (type === 3) {
                    if (score >= 50) { score -= 50; hasMirrorShip = true; }
                }
                updateShopUI();
            };

            window.closeShop = function () {
                shopMenu.style.display = 'none';
                if (gameRunning && !gameOver) {
                    isPaused = false; // Resume game
                    bgMusic.play().catch(e => console.log("Audio play failed", e));
                    lastTime = performance.now(); // Reset time to avoid jump
                } else {
                    postGameMenu.style.display = 'block';
                }
            }

            window.openShopIngame = function () {
                if (!gameRunning || gameOver) return;
                isPaused = true;
                bgMusic.pause();
                shopMenu.style.display = 'block';
                updateShopUI();
            }

            window.cheatScore = function () {
                let newScore = prompt("Mennyi pénzt szeretnél?", score);
                if (newScore !== null) {
                    let parsed = parseInt(newScore);
                    if (!isNaN(parsed)) {
                        score = parsed;
                        updateShopUI(); // Updates displays
                    }
                }
            }

            function updateShopUI() {
                shopMoneyDisplay.textContent = score;
                scoreDisplay.textContent = score; // Sync main display

                document.getElementById('upg1Btn').disabled = (score < 10 || autoFireLevel >= 1);
                document.getElementById('upg1Btn').innerText = autoFireLevel >= 1 ? "MEGVÉVE" : "10 Pont - Automáta (14/mp)";

                document.getElementById('upg2Btn').disabled = (score < 30 || autoFireLevel >= 2);
                document.getElementById('upg2Btn').innerText = autoFireLevel >= 2 ? "MEGVÉVE" : "30 Pont - Gyorstüzelés (20/mp + Dupla)";

                document.getElementById('upg3Btn').disabled = (score < 50 || hasMirrorShip);
                document.getElementById('upg3Btn').innerText = hasMirrorShip ? "MEGVÉVE" : "50 Pont - Tükörhajó";
            }

            startGameBtn.addEventListener('click', () => {
                startGame();
            });

            function startGame() {
                gameOverlay.style.display = 'block';
                postGameMenu.style.display = 'none';
                shopMenu.style.display = 'none';

                gameRunning = true;
                isPaused = false;
                try {
                    if (bgMusic) bgMusic.currentTime = 0;
                } catch (e) { }
                if (bgMusic) bgMusic.play().catch(e => console.log("Audio play failed", e));
                gameOver = false;
                lastTime = performance.now();
                gameElapsedTime = 0;
                loadingProgress = 0;
                bossActive = false;

                // Level 1 Reset
                currentLevel = 1;
                level2Phase = 0;
                playerHP = 10;
                updateHealthUI();
                playerAngle = 0;
                dashCooldown = 0;
                dashTimer = 0;
                wasdShowState = 0;
                const wasdImg = document.getElementById('wasdTutorial');
                if (wasdImg) wasdImg.style.display = 'none';

                const btn = document.getElementById('level2Btn');
                if (btn) btn.classList.remove('centered');

                // Set canvas size (Moved up before positioning)
                gameCanvas.width = window.innerWidth;
                gameCanvas.height = window.innerHeight;
                playerX = gameCanvas.width / 2;
                playerY = gameCanvas.height - 50;

                bullets = [];
                enemies = [];
                particles = [];
                bossMissiles = [];
                isMouseDown = false;

                // Reset Memes
                memeTimers = { alt23: 0, m5: 0, m6: 0, m1: 0, m4: 0, m7: 0 };
                altMemeToggle = false;
                bossMemeTriggered = false;
                document.getElementById('memeLayerBehind').innerHTML = '';
                document.getElementById('memeLayerAbove').innerHTML = '';

                // Initialize Boss
                boss.w = 200; boss.h = 200;
                boss.x = window.innerWidth / 2 - 100;
                boss.y = -250;
                boss.hp = 200;
                boss.phase = 1;
                boss.laserState = 0;

                scoreDisplay.textContent = score;
                requestAnimationFrame(gameLoop);
            }

            function updateHealthUI() {
                const pct = Math.max(0, (playerHP / maxPlayerHP) * 100);
                if (healthBarFill) {
                    healthBarFill.style.width = pct + "%";
                    if (playerHP <= 3) healthBarFill.style.backgroundColor = "red";
                    else if (playerHP <= 6) healthBarFill.style.backgroundColor = "orange";
                    else healthBarFill.style.backgroundColor = "#00ff00";
                }
            }

            finishGameBtn.addEventListener('click', () => {
                // Hard exit
                gameRunning = false;
                bgMusic.pause();
                bgMusic.currentTime = 0;
                const bgMusic2 = document.getElementById('bgMusic2');
                if (bgMusic2) {
                    bgMusic2.pause();
                    bgMusic2.currentTime = 0;
                }
                gameOverlay.style.display = 'none';
            });

            restartBtn.addEventListener('click', startGame);

            shopBtn.addEventListener('click', () => {
                postGameMenu.style.display = 'none';
                shopMenu.style.display = 'block';
                updateShopUI();
            });

            document.addEventListener('keydown', (e) => {
                if ((e.key === 'z' || e.key === 'Z') && gameRunning && !bossActive) {
                    loadingProgress = 40; // Cheat: Instant Boss
                }
            });

            gameCanvas.addEventListener('mousemove', (e) => {
                if (!isPaused) {
                    if (currentLevel === 1 || (currentLevel === 2 && level2Phase < 2)) {
                        playerX = e.clientX;
                    }
                }
            });
            gameCanvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                if (!gameOver && gameRunning && !isPaused) {
                    spawnBullet();
                }
            });
            gameCanvas.addEventListener('mouseup', () => { isMouseDown = false; });
            gameCanvas.addEventListener('mouseleave', () => { isMouseDown = false; }); // Safety

            function spawnBullet() {
                if (isPaused) return;

                // Main Ship Bullets (Upwards)
                if (currentLevel === 1 || (currentLevel === 2 && level2Phase < 2)) {
                    if (autoFireLevel === 2) {
                        // Double Shot Logic
                        bullets.push({ x: playerX - 15, y: gameCanvas.height - 50, width: 10, height: 10, vx: 0, vy: -10 });
                        bullets.push({ x: playerX + 5, y: gameCanvas.height - 50, width: 10, height: 10, vx: 0, vy: -10 });
                    } else {
                        // Single Shot
                        bullets.push({ x: playerX - 5, y: gameCanvas.height - 50, width: 10, height: 10, vx: 0, vy: -10 });
                    }
                }

                // Second Ship (Side Ship)
                if (hasMirrorShip && currentLevel === 1) {
                    let ratio = playerX / gameCanvas.width;
                    let sideY = (gameCanvas.height - 100) * ratio + 50;

                    if (autoFireLevel === 2) {
                        bullets.push({ x: 40, y: sideY - 10, width: 10, height: 10, vx: 10, vy: 0 }); // Shoot Right
                        bullets.push({ x: 40, y: sideY + 10, width: 10, height: 10, vx: 10, vy: 0 });
                    } else {
                        bullets.push({ x: 40, y: sideY, width: 10, height: 10, vx: 10, vy: 0 });
                    }
                } else if (currentLevel === 2 && level2Phase >= 2) {
                    // Shoot towards mouse
                    let dx = mouseX - playerX;
                    let dy = mouseY - playerY;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    let vx = (dx / dist) * 48; // 300% faster (12 * (1 + 3))
                    let vy = (dy / dist) * 48;
                    bullets.push({ x: playerX, y: playerY, width: 10, height: 10, vx: vx, vy: vy });
                }
            }

            let gameWon = false;

            function gameLoop(timestamp) {
                if (!gameRunning) return;

                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;

                if (isPaused) {
                    requestAnimationFrame(gameLoop);
                    return;
                }

                if (gameWon) {
                    ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

                    ctx.font = "bold 50px 'Outfit', sans-serif";
                    ctx.fillStyle = "#00ff00"; // Green
                    ctx.textAlign = "center";
                    ctx.fillText("NYERTÉL!", gameCanvas.width / 2, gameCanvas.height / 2 - 40);

                    const btn = document.getElementById('level2Btn');
                    btn.style.display = 'block';
                    btn.classList.add('centered'); // Show in center on win

                    ctx.fillStyle = "white";
                    ctx.font = "30px 'Outfit', sans-serif";
                    ctx.fillText("KAPTÁL 1000 PÉNZT!", gameCanvas.width / 2, gameCanvas.height / 2 + 20);

                    return;
                }

                if (!gameOver) {
                    gameElapsedTime += deltaTime;

                    if (currentLevel === 2) {
                        const bgMusic2 = document.getElementById('bgMusic2');
                        let ct = bgMusic2.currentTime;

                        // WASD Tutorial Logic
                        const wasdImg = document.getElementById('wasdTutorial');
                        if (ct >= 42 && wasdShowState === 0) {
                            wasdShowState = 1;
                            if (wasdImg) wasdImg.style.display = 'block';
                        }

                        if (wasdShowState === 1) {
                            if (keysPressed['w'] || keysPressed['a'] || keysPressed['s'] || keysPressed['d']) {
                                wasdShowState = 2;
                                wasdHideTimer = 2000; // 2 seconds
                            }
                        } else if (wasdShowState === 2) {
                            wasdHideTimer -= deltaTime;
                            if (wasdHideTimer <= 0) {
                                wasdShowState = 3;
                                if (wasdImg) wasdImg.style.display = 'none';
                            }
                        }

                        let oldPhase = level2Phase;
                        if (ct >= 48) level2Phase = 3;
                        else if (ct >= 43) level2Phase = 2;
                        else level2Phase = 1;

                        if (oldPhase === 1 && level2Phase === 2) {
                            // Clear enemies on transition to WASD
                            enemies.forEach(e => { if (e.dom) e.dom.remove(); });
                            enemies = [];
                        }

                        if (level2Phase >= 2) {
                            // Dash Cooldown
                            if (dashCooldown > 0) dashCooldown -= deltaTime;
                            if (dashTimer > 0) dashTimer -= deltaTime;

                            // Dash Trigger
                            if (keysPressed['shift'] && dashCooldown <= 0) {
                                dashTimer = 150; // 150ms dash
                                dashCooldown = 2000; // 2s cooldown
                            }

                            let speed = 8.5; // 70% faster (5 * 1.7)
                            if (dashTimer > 0) speed *= 4; // Dash burst

                            if (keysPressed['w']) playerY -= speed;
                            if (keysPressed['s']) playerY += speed;
                            if (keysPressed['a']) playerX -= speed;
                            if (keysPressed['d']) playerX += speed;

                            playerX = Math.max(20, Math.min(gameCanvas.width - 20, playerX));
                            playerY = Math.max(20, Math.min(gameCanvas.height - 20, playerY));

                            playerAngle = Math.atan2(mouseY - playerY, mouseX - playerX) + Math.PI / 2;
                        }
                    }

                    // Loading / Boss Timer
                    if (currentLevel === 1 && !bossActive) {
                        if (loadingProgress < 40) {
                            loadingProgress += deltaTime / 1000;
                        }
                        if (loadingProgress >= 40) {
                            bossActive = true;
                            loadingProgress = 40;
                            boss.y = -250;
                        }
                    }

                    // Auto Fire Logic
                    if (isMouseDown && autoFireLevel > 0) {
                        const fireInterval = autoFireLevel === 2 ? (1000 / 20) : (1000 / 14);
                        if (timestamp - lastShotTime > fireInterval) {
                            spawnBullet();
                            lastShotTime = timestamp;
                        }
                    }
                }

                ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

                if (gameOver) {
                    ctx.font = "bold 60px 'Outfit', sans-serif";
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText("vesztettélxdddd", gameCanvas.width / 2, gameCanvas.height / 2);
                }

                // Draw Player
                drawSpaceship(playerX, (currentLevel === 2 && level2Phase >= 2) ? playerY : (gameCanvas.height - 50));

                // Draw Side Ship
                if (hasMirrorShip) {
                    let ratio = playerX / gameCanvas.width;
                    let sideY = (gameCanvas.height - 100) * ratio + 50;

                    // Draw rotated small ship on left (x=20)
                    ctx.fillStyle = "orange"; // Distinct color
                    ctx.fillRect(10, sideY - 10, 20, 20); // Body
                    ctx.fillStyle = "yellow";
                    ctx.fillRect(30, sideY - 5, 10, 10); // Nose pointing right
                }

                // Draw Loading Bar
                if (currentLevel === 1 && !bossActive && !gameOver) {
                    let barW = 300;
                    let barH = 10;
                    let lx = (gameCanvas.width / 2) - (barW / 2);
                    let ly = gameCanvas.height - 30; // Bottom center

                    ctx.fillStyle = "#555";
                    ctx.fillRect(lx, ly, barW, barH);

                    let fillW = (loadingProgress / 40) * barW;
                    ctx.fillStyle = "#00ffff";
                    ctx.fillRect(lx, ly, fillW, barH);

                    ctx.strokeStyle = "white";
                    ctx.strokeRect(lx, ly, barW, barH);

                    ctx.fillStyle = "white";
                    ctx.font = "16px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText(`BOSS BETÖLTÉS: ${Math.floor((loadingProgress / 40) * 100)}%`, gameCanvas.width / 2, ly - 10);
                }

                // Endless Message Level 2
                if (currentLevel === 2 && gameElapsedTime > 30000) {
                    ctx.font = "bold 30px 'Outfit', sans-serif";
                    ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
                    ctx.textAlign = "center";
                    ctx.fillText("Ez endless amúgy szóval ennyi xd", gameCanvas.width / 2, 50);
                }

                if (!gameOver) {
                    // Update and Draw Bullets
                    ctx.fillStyle = "#00ff00";
                    for (let i = bullets.length - 1; i >= 0; i--) {
                        let b = bullets[i];

                        // Handle custom velocities if existent (for side ship)
                        // If vx/vy missing, assume standard (0, -scaling)
                        // The provided vx/vy are fixed pixel movements per frame.
                        if (b.vx !== undefined) {
                            b.x += b.vx;
                            b.y += b.vy;
                        } else {
                            // Fallback for old bullets just in case, or if we want main ship bullets to scale with deltaTime
                            // For consistency with new vx/vy, let's assume main ship bullets also use fixed vy.
                            // If the original behavior of deltaTime scaling is desired, this line should be:
                            // b.y -= (gameCanvas.height / 1000) * deltaTime;
                            // But the instruction provided `vy: -10` for main bullets, implying fixed speed.
                            b.y += b.vy; // Use the fixed vy from spawnBullet
                        }

                        ctx.fillRect(b.x - 5, b.y, b.width, b.height);
                        if (b.y < 0 || b.x < 0 || b.x > gameCanvas.width || b.y > gameCanvas.height) bullets.splice(i, 1);
                    }

                    // Boss Mechanics
                    if (bossActive) {
                        // Move Boss into position (Y=150)
                        if (boss.y < 150) {
                            boss.y += (100 * deltaTime / 1000); // Slide down
                        } else {
                            // Phase 2 Movement
                            if (boss.hp <= 100) {
                                boss.moveTimer += deltaTime;
                                boss.x = (gameCanvas.width / 2 - boss.w / 2) + Math.sin(boss.moveTimer / 1000) * 200;
                                boss.y = 150 + Math.sin(boss.moveTimer / 1200) * 40;
                            } else {
                                boss.x = (gameCanvas.width / 2 - boss.w / 2); // Center
                            }
                        }

                        // Render Boss
                        let bossScale = 0.5 + 0.5 * (boss.hp / 200);
                        let currW = boss.w * bossScale;
                        let currH = boss.h * bossScale;
                        let drawX = boss.x + (boss.w - currW) / 2;
                        let drawY = boss.y + (boss.h - currH) / 2;

                        ctx.fillStyle = boss.hp > 100 ? "red" : "darkred";
                        ctx.fillRect(drawX, drawY, currW, currH);

                        // Boss HP Bar
                        ctx.fillStyle = "black";
                        ctx.fillRect(drawX, drawY - 20, currW, 10);
                        ctx.fillStyle = "lime";
                        ctx.fillRect(drawX, drawY - 20, currW * (boss.hp / 200), 10);

                        // Attacks
                        boss.attackTimer += deltaTime;
                        // Bouncing Missiles every 3s
                        if (boss.attackTimer > 3000) {
                            // Calculate initial vector towards player for start
                            let startDx = playerX - (boss.x + boss.w / 2);
                            let startDy = (gameCanvas.height - 50) - (boss.y + boss.h);
                            let dist = Math.sqrt(startDx * startDx + startDy * startDy);
                            let ivx = (startDx / dist) * 5;
                            let ivy = (startDy / dist) * 5;

                            bossMissiles.push({
                                x: boss.x + boss.w / 2,
                                y: boss.y + boss.h,
                                w: 20, h: 20,
                                vx: ivx, vy: ivy
                            });
                            boss.attackTimer = 0;
                        }

                        // Laser Attack
                        if (Math.random() < 0.005 && boss.laserState === 0) {
                            boss.laserState = 1; // Warn
                            boss.laserTimer = 1500;
                        }

                        if (boss.laserState > 0) {
                            boss.laserTimer -= deltaTime;
                            let centerX = boss.x + boss.w / 2;

                            if (boss.laserState === 1) { // Warning
                                ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                                ctx.fillRect(centerX - 20, boss.y + boss.h, 40, gameCanvas.height);
                                if (boss.laserTimer <= 0) {
                                    boss.laserState = 2; // Fire
                                    boss.laserTimer = 3000;
                                }
                            } else if (boss.laserState === 2) { // Fire
                                ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
                                ctx.fillRect(centerX - 40, boss.y + boss.h, 80, gameCanvas.height);

                                // Laser Collision
                                if (playerX > centerX - 40 && playerX < centerX + 40) {
                                    takeDamage(1);
                                }

                                if (boss.laserTimer <= 0) {
                                    boss.laserState = 3;
                                    boss.laserTimer = 2000; // Cooldown
                                }
                            } else if (boss.laserState === 3) {
                                if (boss.laserTimer <= 0) boss.laserState = 0;
                            }
                        }

                        // Bullet vs Boss
                        for (let i = bullets.length - 1; i >= 0; i--) {
                            let b = bullets[i];
                            if (rectIntersect(b.x, b.y, b.width, b.height, drawX, drawY, currW, currH)) {
                                boss.hp -= 1;
                                createExplosion(b.x, b.y, "orange");
                                bullets.splice(i, 1);
                                if (boss.hp <= 0) {
                                    score += 1000;
                                    scoreDisplay.textContent = score;
                                    bossActive = false;
                                    gameWon = true; // Trigger Win
                                }
                            }
                        }
                    }

                    // Boss Missiles Update (Bouncing)
                    for (let i = bossMissiles.length - 1; i >= 0; i--) {
                        let m = bossMissiles[i];

                        m.x += m.vx;
                        m.y += m.vy;

                        // Bounce Logic
                        let bounced = false;
                        // Only reflect Y, no horizontal bounce
                        if (m.y <= 0 || m.y + m.h >= gameCanvas.height) {
                            m.vy *= -1; // Reflect Y
                            bounced = true;
                        }

                        if (bounced) {
                            let angle = Math.random() * Math.PI * 2;
                            // Enforce non-horizontal bounce (vertical component must be significant)
                            // We want vy to be at least, say, 0.3 of speed
                            // Loop until Angle is safe? Or just clamp?
                            let safe = false;
                            while (!safe) {
                                angle = Math.random() * Math.PI * 2;
                                if (Math.abs(Math.sin(angle)) > 0.3) safe = true;
                            }

                            let speed = 5;
                            m.vx = Math.cos(angle) * speed;
                            m.vy = Math.sin(angle) * speed;

                            // Pull back in bounds slightly to avoid sticking
                            // Only for Y, as X is not bouncing off walls
                            if (m.y <= 0) m.y = 1;
                            if (m.y + m.h >= gameCanvas.height) m.y = gameCanvas.height - m.h - 1;
                        }

                        ctx.fillStyle = "purple";
                        ctx.fillRect(m.x, m.y, m.w, m.h);

                        if (rectIntersect(m.x, m.y, m.w, m.h, playerX - 20, gameCanvas.height - 50, 40, 40)) {
                            takeDamage(1);
                            bossMissiles.splice(i, 1);
                        }
                    }

                    // Spawning
                    let spawnRate = bossActive ? 333 : 1500;
                    if (currentLevel === 2) {
                        spawnRate = level2Phase === 3 ? 200 : 333; // 5/s or 3/s
                    } else if (!bossActive) {
                        if (gameElapsedTime > 5000) {
                            const progress = Math.min((gameElapsedTime - 5000) / 15000, 1);
                            spawnRate = 1500 - (1400 * progress);
                        }
                    }

                    enemySpawnTimer += deltaTime;
                    while (enemySpawnTimer > spawnRate) {
                        enemySpawnTimer -= spawnRate;

                        let ex, ey, isRainbow = false, isPiros = false;
                        if (currentLevel === 2) {
                            if (level2Phase === 3) {
                                let side = Math.floor(Math.random() * 4);
                                if (side === 0) { ex = Math.random() * gameCanvas.width; ey = -50; }
                                else if (side === 1) { ex = Math.random() * gameCanvas.width; ey = gameCanvas.height + 50; }
                                else if (side === 2) { ex = -50; ey = Math.random() * gameCanvas.height; }
                                else { ex = gameCanvas.width + 50; ey = Math.random() * gameCanvas.height; }
                                isRainbow = true;
                            } else {
                                ex = Math.random() * (gameCanvas.width - 40) + 20;
                                ey = -50;
                                isPiros = true;
                            }
                        } else {
                            ex = Math.random() * (gameCanvas.width - 40) + 20;
                            ey = -50;
                        }

                        let isFekete = currentLevel === 1 && Math.random() < 0.1;
                        enemies.push({
                            x: ex, y: ey,
                            width: 40, height: 40,
                            color: isFekete ? "transparent" : (isPiros ? "red" : `hsl(${Math.random() * 360}, 100%, 50%)`),
                            isFekete: isFekete,
                            isRainbow: isRainbow,
                            isHoming: isRainbow
                        });
                    }

                    // Meme Handling
                    memeTimers.alt23 += deltaTime;
                    memeTimers.m5 += deltaTime;
                    memeTimers.m6 += deltaTime;
                    memeTimers.m1 += deltaTime;
                    memeTimers.m4 += deltaTime;
                    memeTimers.m7 += deltaTime;

                    if (memeTimers.alt23 > 20000) {
                        memeTimers.alt23 = 0;
                        altMemeToggle = !altMemeToggle;
                        showMeme(altMemeToggle ? 'meme_2.gif' : 'meme_3.gif', 'memeLayerAbove', 5000, 'meme-full chroma-key-green');
                    }
                    if (memeTimers.m5 > 8000) {
                        memeTimers.m5 = 0;
                        showMeme('meme_5.gif', 'memeLayerAbove', 3000, 'meme-full chroma-key-green');
                    }
                    if (memeTimers.m6 > 10000) {
                        memeTimers.m6 = 0;
                        showMeme('meme_6.gif', 'memeLayerBehind', 4000, 'meme-full chroma-key-green');
                    }
                    if (memeTimers.m1 > 12000) {
                        memeTimers.m1 = 0;
                        showMeme('meme1.gif', 'memeLayerAbove', 3000, 'meme-side meme-left chroma-key-green');
                        showMeme('meme1.gif', 'memeLayerAbove', 3000, 'meme-side meme-right chroma-key-green');
                    }
                    if (memeTimers.m4 > 15000) {
                        memeTimers.m4 = 0;
                        showMeme('meme_4.gif', 'memeLayerAbove', 4000, 'meme-full chroma-key-green');
                    }
                    if (memeTimers.m7 > 25000) {
                        memeTimers.m7 = 0;
                        showMeme('meme_7.gif', 'memeLayerBehind', 5000, 'meme-full chroma-key-green');
                    }

                    if (bossActive && !bossMemeTriggered) {
                        showMeme('meme_end.gif', 'memeLayerAbove', 5000, 'meme-full chroma-key-green');
                        bossMemeTriggered = true;
                    }

                    // Update Entities
                    for (let i = enemies.length - 1; i >= 0; i--) {
                        let e = enemies[i];

                        if (e.isHoming) {
                            let dx = playerX - e.x;
                            let dy = playerY - e.y;
                            let dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist > 0) {
                                e.x += (dx / dist) * 3;
                                e.y += (dy / dist) * 3;
                            }
                        } else {
                            e.y += (gameCanvas.height / 5000) * deltaTime;
                        }

                        if (e.isFekete) {
                            if (!e.dom) {
                                e.dom = document.createElement('img');
                                e.dom.src = './meme_fekete.gif';
                                e.dom.onerror = () => console.error('meme_fekete.gif load failed');
                                e.dom.className = 'meme-gif chroma-key-black';
                                e.dom.style.width = e.width + 'px';
                                e.dom.style.height = e.height + 'px';
                                e.dom.style.display = 'block';
                                document.getElementById('memeLayerAbove').appendChild(e.dom);
                            }
                            e.dom.style.left = (e.x - 20) + 'px';
                            e.dom.style.top = (e.y - 20) + 'px';
                        } else {
                            ctx.fillStyle = e.isRainbow ? `hsl(${Date.now() % 360}, 100%, 50%)` : e.color;
                            ctx.fillRect(e.x - 20, e.y - 20, e.width, e.height);
                        }

                        if (e.y > gameCanvas.height + 100 || e.y < -100 || e.x > gameCanvas.width + 100 || e.x < -100) {
                            // Only take damage if it falls off bottom in Level 1. Level 2 specified only on contact.
                            if (currentLevel === 1 && !e.isHoming && e.y > gameCanvas.height) takeDamage(1);
                            if (e.dom) e.dom.remove();
                            enemies.splice(i, 1);
                        } else if (rectIntersect(e.x - 20, e.y - 20, e.width, e.height, playerX - 20, playerY - 20, 40, 40)) {
                            takeDamage(1);
                            if (e.dom) e.dom.remove();
                            enemies.splice(i, 1);
                        }
                    }
                }

                // Collision
                for (let i = bullets.length - 1; i >= 0; i--) {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        let b = bullets[i]; let e = enemies[j];
                        if (rectIntersect(b.x - 5, b.y, 10, 10, e.x - 20, e.y - 20, 40, 40)) {
                            createExplosion(e.x, e.y, e.isFekete ? "white" : e.color);
                            if (e.dom) e.dom.remove();
                            bullets.splice(i, 1); enemies.splice(j, 1);
                            score++;
                            scoreDisplay.textContent = score;
                            break;
                        }
                    }
                }

                // Particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= deltaTime;
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 500; ctx.fillRect(p.x, p.y, 4, 4); ctx.globalAlpha = 1;
                    if (p.life <= 0) particles.splice(i, 1);
                }

                requestAnimationFrame(gameLoop);
            }

            function drawSpaceship(x, y) {
                ctx.save();
                ctx.translate(x, y);
                if (currentLevel === 2 && level2Phase >= 2) {
                    ctx.rotate(playerAngle);
                }
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(-2, -20, 4, 10);
                ctx.fillRect(-10, -10, 20, 10);
                ctx.fillRect(-20, 0, 40, 10);
                ctx.fillStyle = "#00bcd4";
                ctx.fillRect(-5, -5, 10, 10);
                ctx.restore();
            }

            function createExplosion(x, y, color) {
                for (let i = 0; i < 10; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 5,
                        vy: (Math.random() - 0.5) * 5,
                        life: 500,
                        color: color
                    });
                }
            }

            function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
                return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
            }

            function takeDamage(amount) {
                if (gameOver) return;
                playerHP -= amount;
                updateHealthUI();
                createExplosion(playerX, (currentLevel === 2 && level2Phase >= 2) ? playerY : (gameCanvas.height - 50), "red");
                if (playerHP <= 0) {
                    triggerGameOver();
                }
            }

            function triggerGameOver() {
                gameOver = true;
                // Spawn 2 viruses
                createGameVirusPopup(1);
                createGameVirusPopup(2);
            }

            let activeGameViruses = 0;

            function createGameVirusPopup(index) {
                createVirusPopup(100 + index, true);
            }


            // --- VIRUS ATTACK LOGIC ---
            const virusImages = [
                '../wpviking/virus_alert_window.png',
                '../wpviking/claim_prize_banner.png',
                '../wpviking/sexy_single_ad.png',
                '../wpviking/free_money_banner.png',
                '../wpviking/logo.png',
                '../wpviking/201.gif'
            ];

            const virusTexts = [
                "VIRUS DETECTED!", "UNABLE TO STOP PROCESS", "YOUR COMPUTER IS INFECTED",
                "DOWNLOAD RAM FREE", "HOT SINGLES IN YOUR AREA", "YOU ARE THE 1,000,000TH VISITOR",
                "CLICK HERE TO CLAIM PRIZE", "SYSTEM32 DELETED", "ERROR 404: BRAIN NOT FOUND",
                "SEND MONEY NOW", "WIN IPHONE 75!!!", "TAKE SURVEY NOW", "DOWNLOAD ANTI-VIRUS",
                "INSTALL TOOLBAR", "FREE MP3 DOWNLOAD", "CONGRATULATIONS!", "YOUR IP IS PUBLIC",
                "WEBCAM ACTIVATED", "DATA CORRUPTION IMMINENT", "ILLEGAL OPERATION", "FATAL EXCEPTION 0E"
            ];

            const virusTitles = [
                "WARNING", "CRITICAL ERROR", "CONGRATS!", "HELLO?", "SYSTEM ALERT",
                "WINNER", "ADVERTISEMENT", "SURVEY", "DOWNLOAD", "IMPORTANT",
                "SECURITY", "CMD.EXE", "PRIZE NOTIFICATION"
            ];

            function createVirusPopup(index, isGameVirus = false) {
                const div = document.createElement('div');
                const styles = ['style-classic', 'style-terminal', 'style-alert', 'style-flashy'];
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                div.className = 'popup ' + randomStyle;
                if (isGameVirus) activeGameViruses++;

                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const popupWidth = Math.min(300, viewportWidth * 0.8);

                div.style.width = popupWidth + 'px';

                const rX = Math.floor(Math.random() * (viewportWidth - popupWidth));
                const rY = Math.floor(Math.random() * (viewportHeight - 200));

                div.style.left = rX + 'px';
                div.style.top = rY + 'px';
                div.style.zIndex = 5000 + index;

                let contentHtml = '';
                if (Math.random() > 0.6) {
                    const img = virusImages[Math.floor(Math.random() * virusImages.length)];
                    contentHtml = `<img src="${img}" alt="spam">`;
                } else {
                    const txt = virusTexts[Math.floor(Math.random() * virusTexts.length)];
                    const fontSize = Math.floor(Math.random() * 10) + 16;
                    contentHtml = `<div style="font-size: ${fontSize}px; font-weight: bold;">${txt}</div><br><button style="cursor:pointer; padding: 5px;">${Math.random() > 0.5 ? 'OK' : 'CANCEL'}</button>`;
                }

                const title = virusTitles[Math.floor(Math.random() * virusTitles.length)];

                div.innerHTML = `
                    <div class="popup-header">
                        <span>${title}</span>
                        <div class="popup-close">X</div>
                    </div>
                    <div class="popup-content">
                        ${contentHtml}
                    </div>
                `;

                // Close handler
                const closeBtn = div.querySelector('.popup-close');
                closeBtn.onclick = function () {
                    div.remove();
                    if (isGameVirus) {
                        activeGameViruses--;
                        if (virusContainer.children.length === 0) {
                            // SHOW MENU INSTEAD OF CLOSE
                            postGameMenu.style.display = 'block';
                        }
                    } else {
                        if (virusContainer.children.length === 0) {
                            showRealWin();
                        }
                    }
                };

                virusContainer.appendChild(div);
            }

            function startVirusAttack() {
                const count = 15;
                for (let i = 0; i < count; i++) {
                    createVirusPopup(i);
                }
            }

            // SPACE key listener to clear viruses
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && virusContainer.children.length > 0) {
                    e.preventDefault();
                    if (gameRunning) {
                        virusContainer.innerHTML = '';
                        // SHOW MENU
                        postGameMenu.style.display = 'block';
                        // Stop game processing physically but don't close overlay
                    } else {
                        virusContainer.innerHTML = '';
                        showRealWin();
                    }
                }
            });

            claimBtn.addEventListener('click', () => {
                scamOverlay.style.display = 'none';
                startVirusAttack();
            });

            refuseBtn.addEventListener('click', () => {
                scamOverlay.style.display = 'none';
                hekasOverlay.style.display = 'flex';
            });

            function showRealWin() {
                winSound.currentTime = 0;
                winSound.play().catch(e => console.log("Audio play failed", e));
                winOverlay.style.display = 'flex';

                const duration = 5 * 1000;
                const animationEnd = Date.now() + duration;
                const defaults = {
                    startVelocity: 30,
                    spread: 360,
                    ticks: 60,
                    zIndex: 2000
                };

                function randomInRange(min, max) {
                    return Math.random() * (max - min) + min;
                }

                const interval = setInterval(function () {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }
                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, {
                        particleCount,
                        origin: {
                            x: randomInRange(0.1, 0.3),
                            y: Math.random() - 0.2
                        }
                    }));
                    confetti(Object.assign({}, defaults, {
                        particleCount,
                        origin: {
                            x: randomInRange(0.7, 0.9),
                            y: Math.random() - 0.2
                        }
                    }));
                }, 250);
            }
        });
    </script>
</body>

</html>